<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="/servable/static/css/photochop.css">
    <title>Photochop</title>
	<meta charset="utf-8" />
    <script type="text/javascript">
        var fInput;
        var session;
        var uploading; // To prevent multiple uploads at once.
        function nextUpload(count) {
            if (count == fInput.files.length) {
                window.location = 'ImageCropPage.html?s=' + session + '&c=' + count;
                return;
            }
            var req = new XMLHttpRequest();
            req.open("POST", "/nextUpload/"+session);
            req.onreadystatechange = function () {
                if (req.readyState != XMLHttpRequest.DONE) return;
                if (req.status != 200) {
                    uploading = false;
                    console.log(req);
                    alert('Upload failed!');
                    return;
                }
                nextUpload(count+1);
            }
            req.send(fInput.files[count]);
        }
        function mySubmit(evnt) {
            evnt.preventDefault();
            if (fInput.files.length == 0) {
                alert("Please click 'Choose File(s)' first!");
                return;
            }
            if (uploading) {
                alert("Files still uploading, please be patient ;)");
                return;
            }
            var str = "CONFIRM FILES:";
            for (var f of fInput.files) {
                if (f.type != 'image/png'
                    && f.type != 'image/jpeg'
                    && f.type != 'image/pjpeg'
                    && f.type != 'image/gif') {
                    alert('File "' + f.name + '" isn\'t a .png, .gif, or .jpg. Convert this file, or pick another.');
                    return;
                }
                else if(f.size > 10000000)
                {
	                alert('File "' + f.name + '" should be less than 10MB. Please make another selection.');
	                return;
                }
                str += '\n' + f.name;
            }
            if (!window.confirm(str)) return;
            var req = new XMLHttpRequest();
            req.open("POST", "/initUpload");
            req.onreadystatechange = function () {
                if (req.readyState != XMLHttpRequest.DONE) return;
                if (req.status != 200) {
                    uploading = false;
                    console.log(req);
                    alert('Upload failed!');
                    return;
                }
                session = req.response;
                nextUpload(1);
            }
            req.send(fInput.files[0]);
            uploading = true;
        }
        window.onload = function () {
            fInput = document.getElementById('file');
            document.getElementById('myForm').addEventListener('submit', mySubmit);
        }
    </script>
</head>
<body>
    <h1>PhotoChop</h1>
    <section>
        <form id="myForm" enctype="multipart/form-data" method="post" name="fileinfo">
            <input type="submit" id="upload" value="Upload" />
            <input type="file" id="file" name="file" accept=".png,.jpeg,.jpg,.gif" multiple required />
            <label for="file" id="flabel">Choose File(s)</label>
        </form>
        <p id="slogan">We discover the best parts of your picture</p>
    </section>
</body>
</html>